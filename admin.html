<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°BB Miras - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #FECE07, #FECE07);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .admin-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #FECE07;
        }

        .form-group h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus {
            outline: none;
            border-color: #FECE07;
            box-shadow: 0 0 0 3px rgba(254, 206, 7, 0.1);
        }

        .current-value {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-primary {
            background: #FECE07;
            color: #2c3e50;
        }

        .btn-primary:hover {
            background: #f39c12;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            display: none;
        }

        .status.success {
            background: #d5f4e6;
            color: #27ae60;
            border: 1px solid #27ae60;
        }

        .status.error {
            background: #fdeaea;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        .circle-section {
            grid-column: 1 / -1;
        }

        .circle-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .auth-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .auth-input {
            width: 300px;
            max-width: 100%;
            margin: 10px auto;
            display: block;
        }

        .icon {
            width: 20px;
            height: 20px;
            background: #FECE07;
            border-radius: 50%;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .admin-container {
                margin: 10px;
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Authentication Section -->
        <div class="auth-section" id="authSection">
            <h2>Admin GiriÅŸi</h2>
            <input type="password" id="adminPassword" class="form-group input auth-input" placeholder="Admin ÅŸifresi">
            <button onclick="authenticate()" class="btn btn-primary">GiriÅŸ Yap</button>
        </div>

        <!-- Admin Panel (Hidden by default) -->
        <div id="adminPanel" style="display: none;">
            <div class="header">
                <h1>ğŸ›ï¸ Ä°BB Miras Veri YÃ¶netimi</h1>
                <p>Ä°stanbul'un kÃ¼ltÃ¼r varlÄ±klarÄ±nÄ±n sayÄ±larÄ±nÄ± gÃ¼ncelleyin</p>
            </div>

            <form id="heritageForm">
                <div class="form-grid">
                    <!-- EndÃ¼stri Miras YapÄ±sÄ± -->
                    <div class="form-group">
                        <h3><span class="icon"></span> EndÃ¼stri Miras YapÄ±sÄ±</h3>
                        <label for="endustri">SayÄ±:</label>
                        <input type="number" id="endustri" name="endustri" min="0">
                        <div class="current-value">Mevcut: <span id="current-endustri">-</span></div>
                    </div>

                    <!-- AnÄ±t Eser -->
                    <div class="form-group">
                        <h3><span class="icon"></span> AnÄ±t Eser</h3>
                        <label for="anit">SayÄ±:</label>
                        <input type="number" id="anit" name="anit" min="0">
                        <div class="current-value">Mevcut: <span id="current-anit">-</span></div>
                    </div>

                    <!-- Tarihi TÃ¼rbe -->
                    <div class="form-group">
                        <h3><span class="icon"></span> Tarihi TÃ¼rbe</h3>
                        <label for="turbe">SayÄ±:</label>
                        <input type="number" id="turbe" name="turbe" min="0">
                        <div class="current-value">Mevcut: <span id="current-turbe">-</span></div>
                    </div>

                    <!-- MÃ¼ze ve Sergi MekanÄ± -->
                    <div class="form-group">
                        <h3><span class="icon"></span> MÃ¼ze ve Sergi MekanÄ±</h3>
                        <label for="muze">SayÄ±:</label>
                        <input type="number" id="muze" name="muze" min="0">
                        <div class="current-value">Mevcut: <span id="current-muze">-</span></div>
                    </div>

                    <!-- Kamusal Sanat Eseri -->
                    <div class="form-group">
                        <h3><span class="icon"></span> Kamusal Sanat Eseri</h3>
                        <label for="kamusal">SayÄ±:</label>
                        <input type="number" id="kamusal" name="kamusal" min="0">
                        <div class="current-value">Mevcut: <span id="current-kamusal">-</span></div>
                    </div>

                    <!-- Arkeopark -->
                    <div class="form-group">
                        <h3><span class="icon"></span> Arkeopark</h3>
                        <label for="arkeopark">SayÄ±:</label>
                        <input type="number" id="arkeopark" name="arkeopark" min="0">
                        <div class="current-value">Mevcut: <span id="current-arkeopark">-</span></div>
                    </div>

                    <!-- Tarihi Hazire ve Mezar -->
                    <div class="form-group">
                        <h3><span class="icon"></span> Tarihi Hazire ve Mezar</h3>
                        <label for="hazire">SayÄ±:</label>
                        <input type="number" id="hazire" name="hazire" min="0">
                        <div class="current-value">Mevcut: <span id="current-hazire">-</span></div>
                    </div>

                    <!-- SarnÄ±Ã§ ve Maksem -->
                    <div class="form-group">
                        <h3><span class="icon"></span> SarnÄ±Ã§ ve Maksem</h3>
                        <label for="sarnic">SayÄ±:</label>
                        <input type="number" id="sarnic" name="sarnic" min="0">
                        <div class="current-value">Mevcut: <span id="current-sarnic">-</span></div>
                    </div>

                    <!-- Tarihi Ã‡eÅŸme -->
                    <div class="form-group">
                        <h3><span class="icon"></span> Tarihi Ã‡eÅŸme</h3>
                        <label for="cesme">SayÄ±:</label>
                        <input type="number" id="cesme" name="cesme" min="0">
                        <div class="current-value">Mevcut: <span id="current-cesme">-</span></div>
                    </div>

                    <!-- Dairesel Metin Bilgileri -->
                    <div class="form-group circle-section">
                        <h3><span class="icon"></span> Dairesel Metin Bilgileri</h3>
                        <div class="circle-inputs">
                            <div>
                                <label for="ilce">Ä°lÃ§e SayÄ±sÄ±:</label>
                                <input type="number" id="ilce" name="ilce" min="0">
                                <div class="current-value">Mevcut: <span id="current-ilce">-</span></div>
                            </div>
                            <div>
                                <label for="rota">Rota SayÄ±sÄ±:</label>
                                <input type="number" id="rota" name="rota" min="0">
                                <div class="current-value">Mevcut: <span id="current-rota">-</span></div>
                            </div>
                            <div>
                                <label for="nokta">Nokta SayÄ±sÄ±:</label>
                                <input type="number" id="nokta" name="nokta" min="0">
                                <div class="current-value">Mevcut: <span id="current-nokta">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="buttons">
                    <button type="submit" class="btn btn-primary">ğŸ’¾ Kaydet ve GÃ¼ncelle</button>
                    <button type="button" onclick="resetForm()" class="btn btn-secondary">â†º SÄ±fÄ±rla</button>
                    <button type="button" onclick="loadCurrentData()" class="btn btn-secondary">ğŸ“¥ Supabase'den YÃ¼kle</button>
                    <button type="button" onclick="previewChanges()" class="btn btn-secondary">ğŸ‘ï¸ Ã–nizleme</button>
                </div>
            </form>

            <div id="status" class="status"></div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://nitcvhzbnpvgbzaiesqx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pdGN2aHpibnB2Z2J6YWllc3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzMjg3NzIsImV4cCI6MjA2NTkwNDc3Mn0.3W2DWBuIxHWno1MSsJEwEpK8uAnbKuHIdIJv-K7n-qg';
      
        // Simple authentication
        const ADMIN_PASSWORD = 'ibb2024';
        
        // Global Supabase data - TEK KAYNAK
        let currentData = null;
        
        function authenticate() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadCurrentData(); // Supabase'den yÃ¼kle
            } else {
                alert('YanlÄ±ÅŸ ÅŸifre!');
            }
        }

        // Supabase'den mevcut verileri yÃ¼kle - TEK KAYNAK
        async function loadCurrentData() {
            try {
                showStatus('Veriler yÃ¼kleniyor...', 'success');
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/heritage_data?id=eq.1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const dataArray = await response.json();
                if (dataArray.length === 0) {
                    throw new Error('Supabase\'de veri bulunamadÄ±');
                }

                const heritageData = dataArray[0];
                currentData = heritageData;

                // Form inputlarÄ±nÄ± doldur
                Object.keys(currentData).forEach(key => {
                    if (key !== 'id' && key !== 'created_at' && key !== 'updated_at') {
                        const input = document.getElementById(key);
                        const currentSpan = document.getElementById(`current-${key}`);
                        
                        if (input && currentSpan) {
                            input.value = currentData[key];
                            currentSpan.textContent = currentData[key];
                        }
                    }
                });

                showStatus('âœ… Veriler Supabase\'den baÅŸarÄ±yla yÃ¼klendi!', 'success');
                console.log('Supabase\'den yÃ¼klenen veriler:', heritageData);

            } catch (error) {
                console.error('Supabase load error:', error);
                showStatus('âŒ Veri yÃ¼kleme hatasÄ±: ' + error.message, 'error');
                
                // Fallback: Formu temizle
                resetFormInputs();
            }
        }

        // Form inputlarÄ±nÄ± temizle
        function resetFormInputs() {
            const inputs = document.querySelectorAll('input[type="number"]');
            const spans = document.querySelectorAll('.current-value span');
            
            inputs.forEach(input => input.value = '');
            spans.forEach(span => span.textContent = '-');
        }

        // Form sÄ±fÄ±rlama
        function resetForm() {
            if (currentData) {
                loadCurrentData(); // Supabase'den tekrar yÃ¼kle
            } else {
                resetFormInputs();
            }
        }

        // DeÄŸiÅŸiklikleri Ã¶nizle
        function previewChanges() {
            if (!currentData) {
                alert('Ã–nce veriler yÃ¼klenmelidir.');
                return;
            }

            const formData = new FormData(document.getElementById('heritageForm'));
            const changes = {};
            let hasChanges = false;

            for (let [key, value] of formData.entries()) {
                const newValue = parseInt(value);
                const oldValue = currentData[key];
                
                if (newValue !== oldValue) {
                    changes[key] = {
                        old: oldValue,
                        new: newValue,
                        change: newValue - oldValue
                    };
                    hasChanges = true;
                }
            }

            if (hasChanges) {
                let message = 'YapÄ±lacak deÄŸiÅŸiklikler:\n\n';
                Object.keys(changes).forEach(key => {
                    const change = changes[key];
                    const direction = change.change > 0 ? 'â†—ï¸' : 'â†˜ï¸';
                    message += `${key}: ${change.old} â†’ ${change.new} (${direction} ${Math.abs(change.change)})\n`;
                });
                alert(message);
            } else {
                alert('Herhangi bir deÄŸiÅŸiklik yapÄ±lmamÄ±ÅŸ.');
            }
        }

        // Status mesajÄ± gÃ¶ster
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Supabase'e kaydet
        async function saveToSupabase(data) {
            try {
                // Updated_at otomatik ekle
                data.updated_at = new Date().toISOString();
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/heritage_data?id=eq.1`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Supabase error: ${response.status} - ${errorText}`);
                }

                return true;
            } catch (error) {
                console.error('Supabase save error:', error);
                throw error;
            }
        }

        // Ana sayfayÄ± gÃ¼ncelle
        async function updateMainPage(data) {
            try {
                // Ana sayfadaki verileri gÃ¼ncelle
                if (window.opener && window.opener.updateData) {
                    window.opener.updateData({
                        endustri: { count: data.endustri, texts: ["EndÃ¼stri", "Miras", "YapÄ±sÄ±"] },
                        anit: { count: data.anit, texts: ["AnÄ±t", "Eser"] },
                        turbe: { count: data.turbe, texts: ["Tarihi", "TÃ¼rbe"] },
                        muze: { count: data.muze, texts: ["MÃ¼ze ve", "Sergi MekanÄ±"] },
                        kamusal: { count: data.kamusal, texts: ["Kamusal", "Sanat Eseri"] },
                        arkeopark: { count: data.arkeopark, texts: ["Arkeopark"] },
                        hazire: { count: data.hazire, texts: ["Tarihi", "Hazire ve", "Mezar"] },
                        sarnic: { count: data.sarnic, texts: ["SarnÄ±Ã§ ve", "Maksem"] },
                        cesme: { count: data.cesme, texts: ["Tarihi", "Ã‡eÅŸme"] },
                        circle: { 
                            ilce: data.ilce, 
                            rota: data.rota, 
                            nokta: data.nokta, 
                            description: "ayrÄ± noktalarda Ä°stanbul'un kÃ¼ltÃ¼r varlÄ±klarÄ±nda rutin koruma Ã§alÄ±ÅŸmalarÄ± yapÄ±yoruz." 
                        }
                    });
                    
                    // Ana sayfada animasyonu tetikle
                    if (window.opener.animateNumbers) {
                        setTimeout(() => {
                            window.opener.animateNumbers('admin-update');
                        }, 500);
                    }

                    console.log('Ana sayfa baÅŸarÄ±yla gÃ¼ncellendi');
                } else {
                    console.log('Ana sayfa bulunamadÄ± veya updateData fonksiyonu mevcut deÄŸil');
                }
            } catch (error) {
                console.error('Ana sayfa gÃ¼ncelleme hatasÄ±:', error);
            }
        }

        // Form submit handler
        document.getElementById('heritageForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentData) {
                showStatus('âŒ Ã–nce veriler yÃ¼klenmelidir!', 'error');
                return;
            }
            
            const formData = new FormData(this);
            const data = {};
            
            // Form verilerini al
            for (let [key, value] of formData.entries()) {
                data[key] = parseInt(value);
            }

            try {
                showStatus('Kaydediliyor...', 'success');
                
                // Supabase'e kaydet
                await saveToSupabase(data);
                
                // BaÅŸarÄ±lÄ± ise currentData'yÄ± gÃ¼ncelle
                currentData = { ...currentData, ...data };
                
                // Ana sayfayÄ± gÃ¼ncelle
                await updateMainPage(data);
                
                // Current value span'larÄ±nÄ± gÃ¼ncelle
                Object.keys(data).forEach(key => {
                    const currentSpan = document.getElementById(`current-${key}`);
                    if (currentSpan) {
                        currentSpan.textContent = data[key];
                    }
                });
                
                showStatus('âœ… Veriler baÅŸarÄ±yla kaydedildi ve ana sayfa gÃ¼ncellendi!', 'success');
                console.log('GÃ¼ncellenen veriler:', data);
                
            } catch (error) {
                console.error('Save error:', error);
                showStatus('âŒ Kaydetme sÄ±rasÄ±nda hata oluÅŸtu: ' + error.message, 'error');
            }
        });

        // Sayfa yÃ¼klendiÄŸinde
        window.addEventListener('load', function() {
            console.log('Admin panel yÃ¼klendi');
        });

        // Debug fonksiyonlarÄ±
        window.loadCurrentData = loadCurrentData;
        window.saveToSupabase = saveToSupabase;
        window.getCurrentData = () => currentData;
        
        console.log('ğŸ”§ Admin Panel Debug KomutlarÄ±:');
        console.log('- loadCurrentData() : Supabase\'den veri yÃ¼kle');
        console.log('- getCurrentData() : Mevcut veriyi gÃ¶rÃ¼ntÃ¼le');
    </script>
</body>
</html>